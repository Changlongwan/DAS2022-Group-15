---
output: 
  pdf_document: 
    latex_engine: xelatex
---
---
title: "Analysis of factors affecting the selling price of IKEA furnitures"
author: "Changlong Wan, Lixia Li, Nadsupa Chanachu, Ruiqi Huang & Shuhan Wang"

---

```{r, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, comment = NA, message = FALSE, warning = FALSE)
```

```{r packages}
library(kableExtra)
library(gridExtra)
library(tinytex)
library(equatiomatic)
library(gapminder)
library(ggplot2)
library(dplyr)
library(moderndive)
library(skimr)
library(plotly)
library(tidyr)
library(jtools)
library(janitor)
library(infer)
library(broom)
library(sjPlot)
library(stats)
```

```{r}
#read the data
setwd("C:/Users/86189/Documents")
IKEA<-read.csv("dataset15.csv")
# select variables
IKEA<-IKEA %>%
  select(category,price,sellable_online,other_colors,depth,height,width)
#remove NA data
IKEA<-na.omit(IKEA)
# handling factor variables
IKEA$category<-as.factor(IKEA$category)
IKEA$sellable_online<-as.factor(IKEA$sellable_online)
IKEA$other_colors<-as.factor(IKEA$other_colors)

IKEA$price[IKEA$price<1000]<-"p<1000"
IKEA$price[IKEA$price!="p<1000"]<-"p>=1000"
IKEA$price<-as.factor(IKEA$price)
```

# Introduction 

With the development of economy, people are more and more seeking to improve the quality of life. As an indispensable part of people's lives, furniture has also received more attention. This article will use data from IKEA Saudi Arabia to find out what factors influence the price of furniture over SAR 1000.

We will use a multivariate generalized linear model (GLM) to analyze six factors that can affect prices: category , sellable_online , other_colors , depth , height , and width , and observe correlations and confidence intervals between explanatory and response variables to help we choose variables. Next, we remove inappropriate explanatory variables and fit the remaining explanatory variables and draw conclusions.

# Data Description

## Category

This table indicate the number of each type of furniture.
```{r}
IKEA%>%
  group_by(category)%>%
  summarize(count=n())%>%
  kable(caption = '\\label{tab:category} Data Summary of category')%>%
  kable_styling(latex_options = 'HOLD_position', )
```

```{r, eval = TRUE, out.width = '80%', fig.align = "center", fig.cap = "\\label{fig:box1} Barplot of price by category.", fig.pos = "H"}  
ggplot(data=IKEA,aes(x = price, group = category))+
  geom_bar(aes(y = ..prop..,fill = category), stat = "count", position = "dodge")+
  labs(x="price",y="proportion of category",title = "Barplot of price by category")+
  theme(plot.title = element_text(hjust=0.5))
```

## Sellable_online

```{r}
IKEA %>% 
  tabyl(sellable_online, price) %>% 
  adorn_percentages() %>% 
  adorn_pct_formatting() %>% 
  adorn_ns() %>%
  kable(caption = '\\label{tab:Sellable_online} Data Summary of Sellableonline') %>%
  kable_styling(latex_options = 'HOLD_position', )
```

```{r, eval = TRUE, out.width = '80%', fig.align = "center", fig.cap = "\\label{fig:box2} Barplot of price by sellableonline.", fig.pos = "H"}

ggplot(data=IKEA,aes(x = price, group = sellable_online))+
  geom_bar(aes(y = ..prop..,fill = sellable_online), stat = "count", position = "dodge")+
  labs(x="price",y="Proportion", title = "Barplot of price by sellable_online.")

```

We can see that none of the furniture that is not available for online sale has a price above SAR 1000 (100% vs 0%). And of the furniture offered for sale online, more furniture is below SAR 1,000 (59% vs 41%).

## Other_colors

```{r}
#summarize the data in a table format
IKEA %>% 
  tabyl(other_colors, price) %>% 
  adorn_percentages() %>% 
  adorn_pct_formatting() %>% 
  adorn_ns() %>%
  kable(caption = '\\label{tab:Other_colors} Data Summary of Othercolors') %>%
  kable_styling(font_size = 10, latex_options = "hold_position")
```


```{r, eval = TRUE, out.width = '80%', fig.align = "center", fig.cap = "\\label{fig:box3} Barplot of price by Othercolors.", fig.pos = "H"}
#visualize the distribution using a bar plot
ggplot(data=IKEA,aes(x = price, group = other_colors))+
  geom_bar(aes(y = ..prop..,fill = other_colors), stat = "count", position = "dodge")+
  labs(x="price",y="Proportion", title = "Barplot of price by Other_colors.")
```

We can see that in furniture with other colors (58.2% vs 41.8%) and furniture without other colors (71.7% vs 28.3%), the proportion of furniture priced below SAR 1000 is higher. 

## Depth 

```{r, eval = TRUE, out.width = '80%', fig.align = "center", fig.cap = "\\label{fig:box4} Box Plot of Depth by price.", fig.pos = "H"}
ggplot(data = IKEA,aes(x = price, y = depth, fill = price))+
  geom_boxplot()+
  labs(x="price",y="depth", title = "Box Plot of Depth by price.")
```

## Height

```{r, eval = TRUE, out.width = '80%', fig.align = "center", fig.cap = "\\label{fig:box5} Box Plot of Height by price.", fig.pos = "H"}
ggplot(data = IKEA, aes(x = price, y = height, fill = price)) +
  geom_boxplot() +
  labs(x = "price", y = "height", title = "Box Plot of Height by price.")+ 
  theme(legend.position = "none")
```

Here we can see that the high price group (p>=1000) tend to be more height than that of low price group (p<1000). 

## Width

```{r, eval = TRUE, out.width = '80%', fig.align = "center", fig.cap = "\\label{fig:box6} Box Plot of Width by price.", fig.pos = "H"}
#visualize the distribution using a bar plot
ggplot(data = IKEA,aes(x = price, y = width, fill = price))+
  geom_boxplot()+
  labs(x="price",y="width", title = "Box Plot of Width by price.")
```

Here we can see that furniture priced over SAR 1000 tends to be wider than furniture priced under SAR 1000.

## Data summary

```{r summaries_skim}
my_skim <- skim_with(base = sfl(n = length))
IKEA %>%
  select(depth,height,width) %>%
  my_skim() %>%
#transmute() is similar as mutate().
  transmute(Variable=skim_variable, n=n, Mean=numeric.mean, SD=numeric.sd,
            Min=numeric.p0, Median=numeric.p50,  Max=numeric.p100, 
            IQR = numeric.p75-numeric.p50) %>%
   kable(caption = '\\label{tab:summaryskim} Summary statistics of interested variables',
         booktabs = TRUE, linesep = "", digits = 2) %>%
  #linesep="" turns off the default 5 rows + a space setting.  
   kable_styling(font_size = 10, latex_options = "hold_position")
```

# Formal data analysis

## Multivariate Generalized Linear Models

Next, we built a multivariate generalized linear model for all explanatory variables. We hope to use it to confirm our  variable selection. The model fitting results drop:

```{r}
## price ~ category + sellable_online + other_colors + depth + height + width ##
model.1 <- glm(price ~ category + sellable_online + other_colors + depth + height + width, data = IKEA, family = binomial(link = "logit"))
```

```{r}
# model output
model.1.coef.logodds <- model.1 %>%
                            summary() %>%
                            coef()
model.1.coef.logodds %>%
  kable(caption = '\\label{tab:model.1} Estimates of the parameters from the multivariate model.1') %>%
  kable_styling(latex_options = 'HOLD_position', )
```

```{r}
# confidence interval
confint(model.1) %>%
  kable(caption = '\\label{tab:ciWidth} Confidence interval of the point estimate') %>%
  kable_styling(font_size = 10, latex_options = "hold_position")
```

We found that only two explanatory variables, height and width, were significant and their confidence intervals did not include 0. Therefore, we decided to use these two variables and fit the multivariate model again. The model is as follows:

```{r}
## price ~ height + width ##
model.2 <- glm(price ~ height + width, data = IKEA, family = binomial(link = "logit"))

equatiomatic::extract_eq(model.2)
#This function can automatically transform the model to mathematical equation
```

Fitting the model yields the result:

```{r}
# model output
model.2.coef.logodds <- model.2 %>%
                            summary() %>%
                            coef()
model.2.coef.logodds %>%
  kable(caption = '\\label{tab:model.2} Estimates of the parameters from the multivariate model.2') %>%
  kable_styling(latex_options = 'HOLD_position', )
```

Hence, the best-fitting line is given as:

```{r}
equatiomatic::extract_eq(model.2,use_coefs = TRUE)
```

We see that the coefficients for both height and width are positive, indicating that furniture with greater height and width is more likely to sell for more than SAR 1,000.

This provides us with a point estimate of how the log-odds changes with age, however, we are also interested in producing a 95% confidence interval for these log-odds.

```{r}
# 95% confidence interval
confint(model.2) %>%
  kable(caption = '\\label{tab:cimult} Confidence interval of the point estimate in multivariate model.2') %>%
  kable_styling(font_size = 10, latex_options = "hold_position")
```

For ease of interpretation, we indexed the results.

```{r}
# 95% confidence interval
exp(confint(model.2) ) %>%
  kable(caption = '\\label{tab:multivariate} Confidence interval of the point estimate in multivariate model.2') %>%
  kable_styling(font_size = 10, latex_options = "hold_position")
```

```{r, eval = TRUE, out.width = '80%', fig.align = "center", fig.cap = "\\label{fig:box12} The odds of the price of furniture  over 1000 SAR.", fig.pos = "H"}
# odds graph
plot_model(model.2, show.values = TRUE, 
           title = "Odds (P>1000)", show.p = FALSE, value.offset = 0.25)
```


# Conclusion

We found that, among the six explanatory variables, only width and height have an effect on whether the furniture price exceeds 1000 Saudi Riyal and category, sellable_online, other_colors and depth have no significant effect on it. With each unit increase in the length and width of furniture, the chance that they will cost more than 1000 Saudi riyals increases (by a factor of 1.01 and 1.02).

# Future Work

When dealing with 'NA' datas, we just ommitted all of them, thus the avalible data numbers might be insufficient. There might be better way to tackle with 'NA' data. 

Moreover, the variable 'category' is distinguished according to the type of furnitures， and they are found not to have an obvious impact on the variable 'price'. Maybe it's proper to use clustering to dealing with 'category' to get a better result.






